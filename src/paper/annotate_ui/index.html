<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paper Annotation Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@5/papaparse.min.js"></script>
  <script src="https://unpkg.com/marked@14/marked.min.js"></script>
  <style>
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapsible-content.open { max-height: 2000px; }
    /* Markdown styles for instructions */
    .instructions-content h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: #111827; }
    .instructions-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #1f2937; }
    .instructions-content p { margin-bottom: 0.75rem; line-height: 1.6; }
    .instructions-content ul, .instructions-content ol { margin-left: 1.5rem; margin-bottom: 0.75rem; }
    .instructions-content li { margin-bottom: 0.25rem; }
    .instructions-content strong { font-weight: 600; }
    .instructions-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
    .instructions-content th, .instructions-content td { border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; text-align: left; }
    .instructions-content th { background-color: #f3f4f6; font-weight: 600; }
    .instructions-content tr:nth-child(even) { background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // Parse bullet points from a string (newline separated)
    function parseBullets(text) {
      if (!text || text.trim() === '') return [];
      // Split by newlines or bullet markers
      const lines = text.split(/\n|(?:^|\s)-\s|(?:^|\s)•\s|(?:^|\s)\*\s/)
        .map(s => s.trim())
        // Remove leading bullet characters
        .map(s => s.replace(/^[•\-\*]\s*/, ''))
        .filter(s => s.length > 0);
      return lines;
    }

    // PDF Icon component
    function PdfIcon() {
      return (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5">
          <path fillRule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a1.875 1.875 0 01-1.875-1.875V5.25A3.75 3.75 0 009 1.5H5.625zM7.5 15a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5A.75.75 0 017.5 15zm.75 2.25a.75.75 0 000 1.5H12a.75.75 0 000-1.5H8.25z" clipRule="evenodd" />
          <path d="M12.971 1.816A5.23 5.23 0 0114.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 013.434 1.279 9.768 9.768 0 00-6.963-6.963z" />
        </svg>
      );
    }

    // Collapsible section component
    function Collapsible({ title, children, defaultOpen = false, badge = null }) {
      const [isOpen, setIsOpen] = useState(defaultOpen);
      return (
        <div className="border rounded-lg mb-3 bg-white">
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="w-full px-4 py-3 flex items-center justify-between text-left font-medium text-gray-700 hover:bg-gray-50"
          >
            <span className="flex items-center gap-2">
              {title}
              {badge && <span className="text-xs bg-gray-200 px-2 py-0.5 rounded">{badge}</span>}
            </span>
            <span className="text-gray-400">{isOpen ? '▼' : '▶'}</span>
          </button>
          <div className={`collapsible-content ${isOpen ? 'open' : ''}`}>
            <div className="px-4 pb-4 border-t">{children}</div>
          </div>
        </div>
      );
    }

    // Checkbox list for claims/methods/experiments
    function CheckboxList({ items, values, onChange, label }) {
      if (items.length === 0) return <p className="text-gray-400 italic text-sm">No {label.toLowerCase()} extracted</p>;
      return (
        <div className="space-y-2">
          {items.map((item, idx) => (
            <label key={idx} className="flex items-start gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={values[idx] || false}
                onChange={(e) => {
                  const newValues = [...values];
                  newValues[idx] = e.target.checked;
                  onChange(newValues);
                }}
                className="mt-1 h-4 w-4 rounded border-gray-300"
              />
              <span className="text-sm text-gray-700">{item}</span>
            </label>
          ))}
        </div>
      );
    }

    // Rating radio buttons
    function RatingInput({ value, onChange }) {
      const labels = ['1 - Poor', '2 - Fair', '3 - Good', '4 - Very Good', '5 - Excellent'];
      return (
        <div className="flex flex-wrap gap-4">
          {labels.map((label, idx) => (
            <label key={idx} className="flex items-center gap-1.5 cursor-pointer">
              <input
                type="radio"
                name="rationale-rating"
                checked={value === idx + 1}
                onChange={() => onChange(idx + 1)}
                className="h-4 w-4"
              />
              <span className="text-sm">{label}</span>
            </label>
          ))}
        </div>
      );
    }

    // Instructions Modal
    function InstructionsModal({ onClose }) {
      const [mode, setMode] = useState('blind'); // 'blind' or 'context'
      const [content, setContent] = useState('Loading instructions...');

      useEffect(() => {
        const filename = mode === 'blind' ? 'instructions_blind.md' : 'instructions.md';
        fetch(filename)
          .then(res => res.text())
          .then(md => {
            const html = marked.parse(md);
            setContent(html);
          })
          .catch(err => {
            console.error('Failed to load instructions:', err);
            setContent('<p>Failed to load instructions. Please refresh the page.</p>');
          });
      }, [mode]);

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto">
            <div className="p-6">
              {/* Mode toggle */}
              <div className="flex items-center justify-center gap-3 mb-6 pb-4 border-b">
                <span className={`text-sm ${mode === 'blind' ? 'font-medium text-gray-900' : 'text-gray-500'}`}>
                  Blind
                </span>
                <button
                  onClick={() => setMode(mode === 'blind' ? 'context' : 'blind')}
                  className={`relative w-11 h-6 rounded-full transition-colors ${
                    mode === 'context' ? 'bg-blue-600' : 'bg-gray-300'
                  }`}
                >
                  <span
                    className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${
                      mode === 'context' ? 'translate-x-5' : 'translate-x-0'
                    }`}
                  />
                </button>
                <span className={`text-sm ${mode === 'context' ? 'font-medium text-gray-900' : 'text-gray-500'}`}>
                  With Context
                </span>
              </div>
              <div
                className="instructions-content text-gray-700"
                dangerouslySetInnerHTML={{ __html: content }}
              />
              <div className="mt-6 flex justify-end">
                <button
                  onClick={onClose}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                >
                  Got it
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      const [papers, setPapers] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [annotations, setAnnotations] = useState({});
      const [fileName, setFileName] = useState('');
      const [showInstructions, setShowInstructions] = useState(false);
      const [showRatings, setShowRatings] = useState(false);

      const currentPaper = papers[currentIndex];

      // Load CSV file
      const handleFileLoad = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setFileName(file.name);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            setPapers(results.data);
            setCurrentIndex(0);
            // Log column names for debugging
            console.log('CSV columns:', Object.keys(results.data[0] || {}));
            // Initialize annotations for all papers
            const initAnnotations = {};
            results.data.forEach((_, idx) => {
              initAnnotations[idx] = {
                claims: [],
                methods: [],
                experiments: [],
                rationaleQuality: null,
                comment: '',
                done: false
              };
            });
            setAnnotations(initAnnotations);
            setShowInstructions(true);
          }
        });
      };

      // Update annotation for current paper
      const updateAnnotation = useCallback((field, value) => {
        setAnnotations(prev => ({
          ...prev,
          [currentIndex]: {
            ...prev[currentIndex],
            [field]: value
          }
        }));
      }, [currentIndex]);

      // Navigation
      const goToPaper = (idx) => {
        if (idx >= 0 && idx < papers.length) {
          setCurrentIndex(idx);
        }
      };

      // Save/download augmented CSV
      const handleSave = () => {
        const augmentedData = papers.map((paper, idx) => {
          const ann = annotations[idx] || {};
          const claims = parseBullets(paper.claims || '');
          const methods = parseBullets(paper.methods || '');
          const experiments = parseBullets(paper.experiments || '');

          return {
            ...paper,
            annotation_claims: (ann.claims || []).map((v, i) => v ? 1 : 0).join(';'),
            annotation_methods: (ann.methods || []).map((v, i) => v ? 1 : 0).join(';'),
            annotation_experiments: (ann.experiments || []).map((v, i) => v ? 1 : 0).join(';'),
            annotation_rationale_quality: ann.rationaleQuality || '',
            annotation_comment: ann.comment || '',
            annotation_done: ann.done ? '1' : '0'
          };
        });

        const csv = Papa.unparse(augmentedData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName.replace('.csv', '_annotated.csv');
        link.click();
      };

      // No file loaded yet
      if (papers.length === 0) {
        return (
          <div className="max-w-2xl mx-auto p-8 mt-20">
            <div className="bg-white rounded-xl shadow-lg p-8 text-center">
              <h1 className="text-2xl font-bold text-gray-800 mb-6">Paper Annotation Tool</h1>
              <p className="text-gray-600 mb-6">
                Load a CSV file containing paper evaluations to begin annotating.
              </p>
              <label className="inline-block cursor-pointer bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                <input
                  type="file"
                  accept=".csv"
                  onChange={handleFileLoad}
                  className="hidden"
                />
                Load CSV File
              </label>
            </div>
          </div>
        );
      }

      // Get parsed bullet points
      const claims = parseBullets(currentPaper.claims || '');
      const methods = parseBullets(currentPaper.methods || '');
      const experiments = parseBullets(currentPaper.experiments || '');
      const currentAnn = annotations[currentIndex] || { claims: [], methods: [], experiments: [], rationaleQuality: null, comment: '', done: false };

      // Count done papers
      const doneCount = Object.values(annotations).filter(a => a.done).length;

      return (
        <div className="max-w-4xl mx-auto p-6">
          {/* Header */}
          <div className="bg-white rounded-lg shadow p-4 mb-4 flex items-center justify-between">
            <div>
              <h1 className="text-xl font-bold text-gray-800">Paper Annotation</h1>
              <p className="text-sm text-gray-500">{fileName}</p>
            </div>
            <div className="flex items-center gap-4">
              <span className="text-sm font-medium text-gray-600">
                Paper {currentIndex + 1} of {papers.length}
              </span>
              <span className="text-sm text-green-600 font-medium">
                {doneCount} done
              </span>
              <button
                onClick={() => setShowRatings(!showRatings)}
                className={`px-3 py-2 rounded-lg transition text-sm font-medium ${
                  showRatings
                    ? 'bg-amber-100 text-amber-700 hover:bg-amber-200'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                {showRatings ? 'Hide Ratings' : 'Show Ratings'}
              </button>
              <button
                onClick={() => setShowInstructions(true)}
                className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-medium"
              >
                Instructions
              </button>
              <button
                onClick={handleSave}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-medium"
              >
                Save CSV
              </button>
            </div>
          </div>

          {/* Navigation */}
          <div className="bg-white rounded-lg shadow p-4 mb-4 flex items-center gap-4">
            <button
              onClick={() => goToPaper(currentIndex - 1)}
              disabled={currentIndex === 0}
              className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ← Previous
            </button>
            <select
              value={currentIndex}
              onChange={(e) => goToPaper(parseInt(e.target.value))}
              className="flex-1 px-3 py-2 border rounded-lg"
            >
              {papers.map((p, idx) => {
                const title = p.title || 'Untitled';
                const isDone = annotations[idx]?.done;
                return (
                  <option key={idx} value={idx}>
                    {isDone ? '✓ ' : ''}{idx + 1}. {title.substring(0, 60)}{title.length > 60 ? '...' : ''}
                  </option>
                );
              })}
            </select>
            <button
              onClick={() => goToPaper(currentIndex + 1)}
              disabled={currentIndex === papers.length - 1}
              className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next →
            </button>
          </div>

          {/* Instructions Modal */}
          {showInstructions && <InstructionsModal onClose={() => setShowInstructions(false)} />}

          {/* Paper Info */}
          <div className="bg-white rounded-lg shadow p-6 mb-4">
            <div className="flex items-start gap-3 mb-1">
              <h2 className="text-lg font-semibold text-gray-900 flex-1">
                {currentPaper.title || 'Untitled'}
              </h2>
              {currentPaper.pdf_link && (
                <a
                  href={currentPaper.pdf_link}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium shrink-0"
                >
                  <PdfIcon />
                  PDF
                </a>
              )}
            </div>
            <p className="text-sm text-gray-600 mb-4">
              {currentPaper.authors || 'Unknown authors'}
            </p>

            <Collapsible title="Abstract">
              <p className="text-sm text-gray-700 whitespace-pre-wrap">
                {currentPaper.abstract || 'No abstract available'}
              </p>
            </Collapsible>

            <Collapsible title={`Ground Truth Review${showRatings ? ` (rating: ${currentPaper.ground_truth_rating || '?'})` : ''}`} badge="Reference Only">
              <p className="text-sm text-gray-700 whitespace-pre-wrap">
                {currentPaper.ground_truth_review || 'No ground truth review'}
              </p>
            </Collapsible>

            <Collapsible title={`Predicted Rationale${showRatings ? ` (rating: ${currentPaper.predicted_rating || '?'})` : ''}`} defaultOpen={true}>
              <p className="text-sm text-gray-700 whitespace-pre-wrap">
                {currentPaper.predicted_rationale || 'No predicted rationale'}
              </p>
            </Collapsible>
          </div>

          {/* Annotation Section */}
          <div className="bg-white rounded-lg shadow p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Annotations</h3>
            <p className="text-sm text-gray-500 mb-4">
              Check items that were correctly identified. Rate the overall rationale quality.
            </p>

            <div className="space-y-6">
              {/* Claims */}
              <div>
                <h4 className="font-medium text-gray-700 mb-2">Claims ({claims.length})</h4>
                <CheckboxList
                  items={claims}
                  values={currentAnn.claims}
                  onChange={(v) => updateAnnotation('claims', v)}
                  label="Claims"
                />
              </div>

              {/* Methods */}
              <div>
                <h4 className="font-medium text-gray-700 mb-2">Methods ({methods.length})</h4>
                <CheckboxList
                  items={methods}
                  values={currentAnn.methods}
                  onChange={(v) => updateAnnotation('methods', v)}
                  label="Methods"
                />
              </div>

              {/* Experiments */}
              <div>
                <h4 className="font-medium text-gray-700 mb-2">Experiments ({experiments.length})</h4>
                <CheckboxList
                  items={experiments}
                  values={currentAnn.experiments}
                  onChange={(v) => updateAnnotation('experiments', v)}
                  label="Experiments"
                />
              </div>

              {/* Rationale Quality */}
              <div>
                <h4 className="font-medium text-gray-700 mb-2">Rationale Quality</h4>
                <RatingInput
                  value={currentAnn.rationaleQuality}
                  onChange={(v) => updateAnnotation('rationaleQuality', v)}
                />
              </div>

              {/* Comments */}
              <div>
                <h4 className="font-medium text-gray-700 mb-2">Comments (optional)</h4>
                <textarea
                  value={currentAnn.comment}
                  onChange={(e) => updateAnnotation('comment', e.target.value)}
                  placeholder="Any additional notes about this paper's evaluation..."
                  className="w-full px-3 py-2 border rounded-lg text-sm resize-y min-h-[80px]"
                />
              </div>

              {/* Mark as done */}
              <div className="pt-4 border-t">
                <button
                  onClick={() => updateAnnotation('done', !currentAnn.done)}
                  className={`px-6 py-2.5 rounded-lg font-medium transition ${
                    currentAnn.done
                      ? 'bg-green-100 text-green-700 border-2 border-green-500'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {currentAnn.done ? '✓ Marked as Done' : 'Mark as Done'}
                </button>
              </div>
            </div>
          </div>

          {/* Footer navigation */}
          <div className="mt-4 flex justify-between">
            <button
              onClick={() => goToPaper(currentIndex - 1)}
              disabled={currentIndex === 0}
              className="px-6 py-2 bg-white shadow rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ← Previous Paper
            </button>
            <button
              onClick={() => goToPaper(currentIndex + 1)}
              disabled={currentIndex === papers.length - 1}
              className="px-6 py-2 bg-blue-600 text-white shadow rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next Paper →
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
